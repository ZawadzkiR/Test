import os
import glob
import pandas as pd
from bs4 import BeautifulSoup

def extract_table_from_readme(file_path):
    """
    Funkcja do wyciągania tabeli 'dostepy' z pliku README.md
    """
    with open(file_path, 'r', encoding='utf-8') as file:
        content = file.read()

    # Przekształcenie zawartości README.md na obiekt BeautifulSoup
    soup = BeautifulSoup(content, 'html.parser')

    # Szukamy tabel w pliku
    tables = soup.find_all('table')

    # Szukamy tabeli, która zawiera kolumny 'Nazwa', 'źródło' i 'level'
    for table in tables:
        headers = [th.get_text(strip=True) for th in table.find_all('th')]
        if 'Nazwa' in headers and 'źródło' in headers and 'level' in headers:
            # Zamiana tabeli na DataFrame pandas
            df = pd.read_html(str(table))[0]
            return df
    return None

def create_combined_table(directory, output_file):
    """
    Funkcja do wyciągania tabel dostepów z plików README.md i zapisania ich w jednym pliku
    """
    readme_files = glob.glob(os.path.join(directory, '**', 'README.md'), recursive=True)
    combined_df = pd.DataFrame(columns=["Nazwa", "źródło", "level"])

    # Iteracja po plikach README.md
    for readme in readme_files:
        table_df = extract_table_from_readme(readme)
        if table_df is not None:
            # Dodajemy dane do złączonej tabeli
            combined_df = pd.concat([combined_df, table_df], ignore_index=True)

    # Usuwanie duplikatów
    combined_df.drop_duplicates(inplace=True)

    # Zapisanie wynikowej tabeli do pliku README.md
    with open(output_file, 'w', encoding='utf-8') as outfile:
        outfile.write("# Połączona tabela dostępów\n\n")
        outfile.write(combined_df.to_markdown(index=False))

    print(f"Plik {output_file} został utworzony.")

# Użycie funkcji
create_combined_table('/ścieżka/do/katalogu', 'combined_dostepy_README.md')
