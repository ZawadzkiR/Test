import sys
import os
import datetime
import yaml
import subprocess

# Wczytaj konfigurację
with open("config.yaml") as f:
    config = yaml.safe_load(f)

def is_weekday():
    return datetime.datetime.today().weekday() < 5  # 0-4 to pon-pt

def run_job(job_name):
    job_config = config.get(job_name, {})
    if not job_config:
        print(f"Brak konfiguracji dla {job_name}")
        return

    if job_config.get("only_weekdays") and not is_weekday():
        print(f"Pomijam {job_name} - tylko w dni robocze")
        return

    script_path = os.path.join("jobs", f"{job_name}.py")

    if not os.path.isfile(script_path):
        print(f"Plik {script_path} nie istnieje")
        return

    try:
        print(f"\n=== Uruchamiam {job_name} ===")
        result = subprocess.run(
            [sys.executable, script_path],
            capture_output=True,
            text=True,
            check=True
        )
        print(result.stdout)
        if result.stderr:
            print(f"--- Błędy {job_name} ---")
            print(result.stderr)
    except subprocess.CalledProcessError as e:
        print(f"Błąd podczas uruchamiania {job_name}:")
        print(e.stdout)
        print(e.stderr)

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Użycie: python runner.py job1 [job2 job3...]")
        sys.exit(1)

    for job in sys.argv[1:]:
        run_job(job)
