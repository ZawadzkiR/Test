import requests

# ======== KONFIGURACJA ========
username      = "TWOJ_USERNAME"
app_password  = "TWOJE_APP_HASLO"
workspace     = "TWOJE_WORKSPACE"
repo_slug     = "TWOJE_REPO"
branch_name   = "master"
plik_path     = "log.txt"
commit_msg    = "Aktualizacja log.txt (force)"
# ===============================

# 1. Pobierz ostatni commit SHA z gałęzi
url_branch = f"https://api.bitbucket.org/2.0/repositories/{workspace}/{repo_slug}/refs/branches/{branch_name}"
resp = requests.get(url_branch, auth=(username, app_password))

if resp.status_code != 200:
    print("❌ Nie udało się pobrać informacji o gałęzi.")
    print(resp.text)
    exit(1)

last_commit_sha = resp.json()["target"]["hash"]
print(f"✅ SHA ostatniego commita: {last_commit_sha}")

# 2. Wyślij nowy plik jako commit z tym SHA jako jedynym rodzicem
url_commit = f"https://api.bitbucket.org/2.0/repositories/{workspace}/{repo_slug}/src"

with open(plik_path, "rb") as f:
    files = {
        "log.txt": f
    }
    data = {
        "branch": branch_name,
        "message": commit_msg,
        "parents": last_commit_sha,
    }
    resp2 = requests.post(url_commit, auth=(username, app_password), files=files, data=data)

if resp2.status_code in (200, 201):
    print("✅ Plik nadpisany w gałęzi master – symulowany force push zakończony.")
else:
    print("❌ Błąd przy tworzeniu commita:")
    print(resp2.status_code)
    print(resp2.text)
