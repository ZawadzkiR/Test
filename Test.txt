import os
import yaml
import subprocess
import getpass
import tempfile

# Ścieżka do Pythona i runnera
PYTHON_PATH = subprocess.check_output(["which", "python3"]).decode().strip()
RUNNER_PATH = os.path.abspath("runner.py")

# Nazwa użytkownika aktualnie uruchamiającego skrypt
CURRENT_USER = getpass.getuser()

# Wczytaj YAML
with open("tasks.yaml") as f:
    tasks = yaml.safe_load(f)

# Filtruj tylko zadania przypisane do aktualnego użytkownika
filtered_tasks = {
    name: task for name, task in tasks.items()
    if task.get("user", CURRENT_USER) == CURRENT_USER
}

# Zbuduj unikalne wpisy crontaba
seen_entries = set()
new_entries = []

for task_name, task in filtered_tasks.items():
    schedules = task.get("schedule")
    enabled = task.get("enabled", True)

    if not schedules:
        continue

    # pozwalamy na listę lub pojedynczy string
    if isinstance(schedules, str):
        schedules = [schedules]

    if "command" in task:
        command = task["command"]
    elif "jobs" in task:
        job_args = " ".join(task["jobs"])
        command = f"{PYTHON_PATH} {RUNNER_PATH} {job_args}"
    else:
        continue  # niepoprawna definicja taska

    for schedule in schedules:
        key = (schedule, command)
        if key in seen_entries:
            continue  # nie dodawaj duplikatu
        seen_entries.add(key)

        line = f"{schedule} {command} >> /tmp/{task_name}.log 2>&1  # Automate: {task_name}"
        if not enabled:
            line = f"# {line}"
        new_entries.append(line)

# Pobierz obecny crontab użytkownika
result = subprocess.run(["crontab", "-l"], capture_output=True, text=True)
existing_cron = result.stdout if result.returncode == 0 else ""

# Usuń stare wpisy # Automate:
filtered_lines = [line for line in existing_cron.splitlines() if "# Automate:" not in line]

# Dodaj nowe wpisy
final_cron = "\n".join(filtered_lines + new_entries) + "\n"

# Zapisz i załaduj
with tempfile.NamedTemporaryFile(delete=False, mode="w") as tmpfile:
    tmpfile.write(final_cron)
    tmpfile_path = tmpfile.name

subprocess.run(["crontab", tmpfile_path])
os.unlink(tmpfile_path)

print(f"✅ Crontab zaktualizowany dla użytkownika: {CURRENT_USER}")
