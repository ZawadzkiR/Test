import os
import sys
import shutil
import zipfile
from pathlib import Path
import ctypes
import tempfile
import base64

# Zakodowany zip jako base64 (wklejony ni≈ºej)
embedded_zip_b64 = """
<--- tutaj wkleimy dane ZIP jako base64 --->
"""

INSTALL_DIR = Path("C:/Program Files/Aplikacja")
DESKTOP = Path(os.path.join(os.environ["USERPROFILE"], "Desktop"))
SHORTCUT_NAME = "Aplikacja.lnk"

def is_admin():
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def create_shortcut(target, shortcut_path, icon_path=None):
    import pythoncom
    from win32com.client import Dispatch
    shell = Dispatch('WScript.Shell')
    shortcut = shell.CreateShortcut(str(shortcut_path))
    shortcut.TargetPath = str(target)
    shortcut.WorkingDirectory = str(target.parent)
    if icon_path:
        shortcut.IconLocation = str(icon_path)
    shortcut.save()

def install():
    print("üì¶ Rozpakowywanie aplikacji...")

    INSTALL_DIR.mkdir(parents=True, exist_ok=True)

    # Dekoduj zip z base64 do tymczasowego pliku
    zip_data = base64.b64decode(embedded_zip_b64)
    with tempfile.NamedTemporaryFile(delete=False, suffix=".zip") as tmp_zip:
        tmp_zip.write(zip_data)
        zip_path = tmp_zip.name

    # Wypakuj zip
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(INSTALL_DIR)

    # Utw√≥rz skr√≥t (je≈õli jest app.exe)
    exe_path = INSTALL_DIR / "app.exe"
    if exe_path.exists():
        create_shortcut(exe_path, DESKTOP / SHORTCUT_NAME)

    print("‚úÖ Zainstalowano pomy≈õlnie.")

if __name__ == "__main__":
    if not is_admin():
        ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, __file__, None, 1)
    else:
        install()
        input("Naci≈õnij Enter aby zako≈Ñczyƒá...")
