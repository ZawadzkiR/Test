import os
import glob
import pandas as pd

def extract_table_from_readme(file_path):
    """
    Funkcja do wyciągania tabeli 'dostepy' z pliku README.md w formacie Markdown
    """
    with open(file_path, 'r', encoding='utf-8') as file:
        content = file.read()

    # Szukamy wszystkich tabel w formacie Markdown
    lines = content.split('\n')
    table_start = False
    table_lines = []
    
    for line in lines:
        if line.startswith('|'):
            # Dodajemy linie tabeli do listy
            table_lines.append(line)
            table_start = True
        elif table_start and line.strip() == '':
            # Koniec tabeli, przerwij
            break

    if table_lines:
        # Połącz tabelę z listy w jeden ciąg znaków
        table_markdown = '\n'.join(table_lines)
        # Używamy pandas do wczytania tabeli w formacie markdown
        df = pd.read_csv(pd.compat.StringIO(table_markdown), sep="|", engine='python').iloc[:, 1:-1]
        df.columns = [col.strip() for col in df.columns]
        return df
    return None

def create_combined_table(directory, output_file):
    """
    Funkcja do wyciągania tabel dostepów z plików README.md i zapisania ich w jednym pliku
    """
    readme_files = glob.glob(os.path.join(directory, '**', 'README.md'), recursive=True)
    combined_df = pd.DataFrame(columns=["Nazwa", "źródło", "level"])

    # Iteracja po plikach README.md
    for readme in readme_files:
        table_df = extract_table_from_readme(readme)
        if table_df is not None:
            # Dodajemy dane do złączonej tabeli
            combined_df = pd.concat([combined_df, table_df], ignore_index=True)

    # Usuwanie duplikatów
    combined_df.drop_duplicates(inplace=True)

    # Zapisanie wynikowej tabeli do pliku README.md w formacie markdown
    with open(output_file, 'w', encoding='utf-8') as outfile:
        outfile.write("# Połączona tabela dostępów\n\n")
        outfile.write(combined_df.to_markdown(index=False))

    print(f"Plik {output_file} został utworzony.")

# Użycie funkcji
create_combined_table('/ścieżka/do/katalogu', 'combined_dostepy_README.md')
